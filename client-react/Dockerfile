# === Stage 1: Build React App ===
FROM node:22-slim AS build

WORKDIR /usr/src/app

COPY package*.json ./

RUN --mount=type=cache,target=/usr/src/app/.npm \
    npm set cache /usr/src/app/.npm && \
    npm ci

COPY . .

RUN npm run build

# === Stage 2: Serve with secure nginx ===
FROM nginx:stable-alpine AS prod

# –°–æ–∑–¥–∞—ë–º –∫–∞—Ç–∞–ª–æ–≥–∏ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ (–¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ nginx)
RUN mkdir -p /tmp/nginx/cache /tmp/nginx/run /tmp/nginx/logs \
    && chmod -R 777 /tmp/nginx

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
COPY --link nginx.conf /etc/nginx/conf.d/default.conf
COPY --link main-nginx.conf /tmp/nginx.conf

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
COPY --link --from=build /usr/src/app/dist/ /usr/share/nginx/html

# üîê –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN addgroup -S appgroup && adduser -S appuser -G appgroup \
    && chown -R appuser:appgroup /usr/share/nginx/html

# üîê –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER appuser

# üå° HEALTHCHECK –¥–ª—è React + nginx
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD ["wget", "--spider", "-q", "http://localhost:8080/"]

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8080

# –ó–∞–ø—É—Å–∫ nginx
CMD ["nginx", "-c", "/tmp/nginx.conf"]
